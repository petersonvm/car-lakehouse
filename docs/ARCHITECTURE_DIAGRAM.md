# Arquitetura: MigraÃ§Ã£o Lambda â†’ Glue Job

## ğŸ“Š Diagrama de Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AWS DATA LAKEHOUSE ARCHITECTURE                          â”‚
â”‚                              (Medallion: Bronze â†’ Silver)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FASE 1: INGESTÃƒO (Landing â†’ Bronze) - SEM ALTERAÃ‡Ã•ES                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   ğŸ“ S3 Landing                    âš¡ Lambda Ingestion              ğŸ“ S3 Bronze
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚             â”‚  S3 Event        â”‚                  â”‚           â”‚               â”‚
   â”‚  car_raw    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚  â€¢ JSON â†’ Parquetâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  Parquet      â”‚
   â”‚  .json      â”‚  ObjectCreated   â”‚  â€¢ Normalize     â”‚           â”‚  (nested)     â”‚
   â”‚             â”‚                  â”‚    types         â”‚           â”‚               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â€¢ Preserve      â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚    structs       â”‚
                                    â”‚                  â”‚
                                    â”‚  Runtime:        â”‚           ğŸ—ƒï¸ Glue Catalog
                                    â”‚  â€¢ Python 3.9    â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  â€¢ 512 MB        â”‚  Crawled  â”‚ bronze_       â”‚
                                    â”‚  â€¢ 120s timeout  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ ingest_       â”‚
                                    â”‚  â€¢ Pandas Layer  â”‚           â”‚ year_2025     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FASE 2: TRANSFORMAÃ‡ÃƒO (Bronze â†’ Silver) - MIGRAÃ‡ÃƒO REALIZADA                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ âŒ ARQUITETURA ANTIGA (Lambda Event-Driven)                                         â•‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

   ğŸ“ S3 Bronze                     âš¡ Lambda Cleansing             ğŸ“ S3 Silver
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚             â”‚  S3 Event        â”‚                  â”‚           â”‚               â”‚
   â”‚  Parquet    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚  â€¢ Flatten       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  Parquet      â”‚
   â”‚  (nested)   â”‚  ObjectCreated   â”‚  â€¢ Cleanse       â”‚  APPEND   â”‚  (flat)       â”‚
   â”‚             â”‚                  â”‚  â€¢ Enrich        â”‚           â”‚               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â€¢ Partition     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚                  â”‚
     Arquivo 1 â”€â”€â”€â”€> Lambda â”€â”€â”€â”€> Silver/file1.parquet
     Arquivo 2 â”€â”€â”€â”€> Lambda â”€â”€â”€â”€> Silver/file2.parquet
     Arquivo 3 â”€â”€â”€â”€> Lambda â”€â”€â”€â”€> Silver/file3.parquet
     
     âš ï¸ PROBLEMA: MÃºltiplos arquivos para o mesmo carChassis + event_day
     âš ï¸ RESULTADO: Duplicatas no Athena
     
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ âœ… ARQUITETURA NOVA (Glue Job Scheduled + Consolidation)                            â•‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

   ğŸ“ S3 Bronze                     ğŸ”§ AWS Glue Job                ğŸ“ S3 Silver
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚             â”‚                  â”‚                  â”‚           â”‚               â”‚
   â”‚  Parquet    â”‚  Job Bookmarks   â”‚  ETAPA 1:        â”‚           â”‚  Parquet      â”‚
   â”‚  (nested)   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚  Read NEW files  â”‚           â”‚  (flat)       â”‚
   â”‚             â”‚  (apenas novos)  â”‚  from Bronze     â”‚           â”‚  CONSOLIDATED â”‚
   â”‚  file1.pq   â”‚                  â”‚                  â”‚           â”‚               â”‚
   â”‚  file2.pq   â”‚                  â”‚  ETAPA 2:        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚  file3.pq   â”‚                  â”‚  Transform       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â€¢ Flatten       â”‚           ğŸ—ƒï¸ Glue Catalog
                                    â”‚  â€¢ Cleanse       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  â€¢ Enrich        â”‚  Crawled  â”‚ silver_car_   â”‚
        â° EventBridge               â”‚  â€¢ Partition     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ telemetry     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ Cron Triggerâ”‚             â”‚  ETAPA 3:        â”‚
        â”‚ (Hourly)    â”‚             â”‚  Read EXISTING   â”‚
        â”‚             â”‚             â”‚  Silver data     â”‚           ğŸ“Š Athena
        â”‚ 0 */1 * * ? â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                  â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Start Job  â”‚  ETAPA 4:        â”‚  Queries  â”‚ SELECT *      â”‚
                                    â”‚  Union + Dedup   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ FROM silver_  â”‚
                                    â”‚  (Window func)   â”‚           â”‚ car_telemetry â”‚
        ğŸ§  Deduplication:           â”‚                  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  ETAPA 5:        â”‚
        â”‚ Window Function:    â”‚    â”‚  Write with      â”‚
        â”‚                     â”‚    â”‚  Dynamic         â”‚
        â”‚ PARTITION BY:       â”‚    â”‚  Partition       â”‚
        â”‚  â€¢ carChassis       â”‚    â”‚  Overwrite       â”‚
        â”‚  â€¢ event_year       â”‚    â”‚                  â”‚
        â”‚  â€¢ event_month      â”‚    â”‚  Runtime:        â”‚
        â”‚  â€¢ event_day        â”‚    â”‚  â€¢ Spark 3.3     â”‚
        â”‚                     â”‚    â”‚  â€¢ 2Ã—G.1X DPUs   â”‚
        â”‚ ORDER BY:           â”‚    â”‚  â€¢ 60min timeout â”‚
        â”‚  â€¢ currentMileage   â”‚    â”‚  â€¢ PySpark 3     â”‚
        â”‚    DESC             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚
        â”‚ KEEP: row_num = 1   â”‚    âœ… RESULTADO: Apenas 1 registro por chave
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    âœ… PartiÃ§Ãµes sobrescritas dinamicamente

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXEMPLO DE PROCESSAMENTO                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Input (Bronze - 3 arquivos):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ carChassis | currentMileage | event_day | arquivo         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 5ifRW...   | 4321           | 29        | file1.parquet   â”‚  â† Upload 1
  â”‚ 5ifRW...   | 8500           | 29        | file2.parquet   â”‚  â† Upload 2
  â”‚ 5ifRW...   | 12000          | 29        | file3.parquet   â”‚  â† Upload 3
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Lambda (Antigo) - APPEND:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Silver Output: 3 registros (DUPLICATAS âŒ)                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 5ifRW... | 4321   | 29                                     â”‚
  â”‚ 5ifRW... | 8500   | 29                                     â”‚
  â”‚ 5ifRW... | 12000  | 29                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Glue Job (Novo) - CONSOLIDATION:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Silver Output: 1 registro (ÃšNICO âœ…)                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 5ifRW... | 12000  | 29    â† Maior milhagem mantida        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INFRAESTRUTURA TERRAFORM                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  âœ… RECURSOS CRIADOS (11)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ S3 Buckets                                                           â”‚
  â”‚  â€¢ aws_s3_bucket.glue_scripts (scripts PySpark)                      â”‚
  â”‚  â€¢ aws_s3_bucket.glue_temp (arquivos temporÃ¡rios)                    â”‚
  â”‚                                                                      â”‚
  â”‚ S3 Objects                                                           â”‚
  â”‚  â€¢ aws_s3_object.silver_consolidation_script (upload script)         â”‚
  â”‚                                                                      â”‚
  â”‚ IAM                                                                  â”‚
  â”‚  â€¢ aws_iam_role.glue_job (role principal)                            â”‚
  â”‚  â€¢ aws_iam_role_policy.glue_s3_access (Bronze read, Silver RWD)     â”‚
  â”‚  â€¢ aws_iam_role_policy.glue_catalog_access (Catalog full access)    â”‚
  â”‚  â€¢ aws_iam_role_policy.glue_cloudwatch_logs (Logs write)            â”‚
  â”‚                                                                      â”‚
  â”‚ Glue                                                                 â”‚
  â”‚  â€¢ aws_glue_job.silver_consolidation (Job ETL)                       â”‚
  â”‚  â€¢ aws_glue_trigger.silver_consolidation_schedule (Trigger cron)     â”‚
  â”‚                                                                      â”‚
  â”‚ CloudWatch                                                           â”‚
  â”‚  â€¢ aws_cloudwatch_log_group.glue_job_logs (14 dias retenÃ§Ã£o)        â”‚
  â”‚                                                                      â”‚
  â”‚ Data Sources                                                         â”‚
  â”‚  â€¢ data.aws_caller_identity.current (Account ID)                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  âŒ RECURSOS REMOVIDOS (2)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ â€¢ aws_lambda_permission.allow_s3_invoke_cleansing                    â”‚
  â”‚ â€¢ aws_s3_bucket_notification.bronze_bucket_notification              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  âšª RECURSOS MANTIDOS (sem alteraÃ§Ãµes)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ â€¢ aws_lambda_function.ingestion (Landing â†’ Bronze)                   â”‚
  â”‚ â€¢ aws_lambda_function.cleansing (mantida, mas nÃ£o acionada)          â”‚
  â”‚ â€¢ aws_s3_bucket.data_lake[*] (todos os buckets)                      â”‚
  â”‚ â€¢ aws_glue_crawler.bronze_crawler                                    â”‚
  â”‚ â€¢ aws_glue_crawler.silver_crawler                                    â”‚
  â”‚ â€¢ aws_athena_workgroup.data_lake                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLUXO DE DADOS DETALHADO - NOVA ARQUITETURA                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  1ï¸âƒ£  Upload JSON
      â””â”€> s3://landing/car_raw.json
  
  2ï¸âƒ£  Lambda Ingestion (automÃ¡tico, S3 trigger)
      â”œâ”€> LÃª JSON
      â”œâ”€> Normaliza tipos (int â†’ float em structs)
      â”œâ”€> Converte para Parquet (mantÃ©m nested structs)
      â””â”€> Escreve s3://bronze/ingest_year=2025/.../*.parquet
  
  3ï¸âƒ£  Crawler Bronze (agendado ou manual)
      â”œâ”€> Escaneia s3://bronze/
      â”œâ”€> Detecta schema (com structs: metrics.trip.*, etc.)
      â””â”€> Atualiza Glue Catalog: bronze_ingest_year_2025
  
  4ï¸âƒ£  Glue Job (agendado - horÃ¡rio via EventBridge)
      â”œâ”€> [ETAPA 1] LÃª NOVOS dados do Bronze (Job Bookmarks)
      â”‚   â””â”€> SELECT * FROM bronze_ingest_year_2025 WHERE [novos arquivos]
      â”‚
      â”œâ”€> [ETAPA 2] Aplica transformaÃ§Ãµes Silver (PySpark)
      â”‚   â”œâ”€> Flatten: metrics.trip.tripMileage â†’ metrics_trip_tripMileage
      â”‚   â”œâ”€> Cleanse: Manufacturer â†’ Title Case, color â†’ lowercase
      â”‚   â”œâ”€> Convert: String timestamps â†’ timestamp type
      â”‚   â”œâ”€> Enrich: 
      â”‚   â”‚   â€¢ fuel_level_percentage = (fuelAvailable / fuelCapacity) Ã— 100
      â”‚   â”‚   â€¢ km_per_liter = tripMileage / tripFuelLiters
      â”‚   â””â”€> Partition: event_year, event_month, event_day (from metricTimestamp)
      â”‚
      â”œâ”€> [ETAPA 3] LÃª dados EXISTENTES do Silver
      â”‚   â””â”€> spark.read.parquet("s3://silver/car_telemetry/")
      â”‚
      â”œâ”€> [ETAPA 4] Union + DeduplicaÃ§Ã£o
      â”‚   â”œâ”€> df_union = df_new.unionByName(df_existing)
      â”‚   â”œâ”€> Window.partitionBy("carChassis", "event_year", "event_month", "event_day")
      â”‚   â”‚         .orderBy(col("currentMileage").desc())
      â”‚   â”œâ”€> row_number() OVER (window_spec)
      â”‚   â””â”€> FILTER WHERE row_num = 1  â† MantÃ©m apenas maior milhagem
      â”‚
      â””â”€> [ETAPA 5] Escreve com Dynamic Partition Overwrite
          â”œâ”€> spark.conf.set("partitionOverwriteMode", "dynamic")
          â””â”€> df.write.parquet("s3://silver/car_telemetry/", mode="overwrite", partitionBy=[...])
              â””â”€> Sobrescreve APENAS partiÃ§Ãµes afetadas (event_day=29)
  
  5ï¸âƒ£  Crawler Silver (agendado ou manual)
      â”œâ”€> Escaneia s3://silver/car_telemetry/
      â”œâ”€> Detecta schema (flat, sem structs)
      â””â”€> Atualiza Glue Catalog: silver_car_telemetry
  
  6ï¸âƒ£  Athena Query
      â””â”€> SELECT * FROM silver_car_telemetry WHERE event_day = '29'
          â””â”€> Retorna: 1 registro Ãºnico por carChassis âœ…

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TECNOLOGIAS E VERSÃ•ES                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Lambda Ingestion:
    â€¢ Python 3.9
    â€¢ Pandas 2.0.3 (via Layer)
    â€¢ PyArrow 13.0.0 (via Layer)
    â€¢ Boto3 (built-in)
    â€¢ Memory: 512 MB
    â€¢ Timeout: 120s

  AWS Glue Job:
    â€¢ Glue Version: 4.0
    â€¢ Spark: 3.3.0
    â€¢ Python: 3.10
    â€¢ PySpark: 3.3.0
    â€¢ Worker: G.1X (4 vCPU, 16 GB RAM)
    â€¢ Workers: 2 (auto-scaling habilitado)
    â€¢ Timeout: 60 min

  Terraform:
    â€¢ Version: >= 1.0
    â€¢ AWS Provider: >= 5.0

  AWS Services:
    â€¢ S3 (storage)
    â€¢ Lambda (ingestion)
    â€¢ Glue (ETL + Catalog)
    â€¢ Athena (queries)
    â€¢ CloudWatch (logs + metrics)
    â€¢ IAM (permissions)
    â€¢ EventBridge (scheduling)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CUSTOS COMPARATIVOS                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ANTES (Lambda Cleansing):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Componente         â”‚ Custo/MÃªs    â”‚ ObservaÃ§Ãµes     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Lambda Requests    â”‚ $0,0006      â”‚ 3.000 requests  â”‚
  â”‚ Lambda Compute     â”‚ $1,50        â”‚ 90.000 GB-s     â”‚
  â”‚ S3 (Silver)        â”‚ $0,50        â”‚ ~20 GB          â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚ TOTAL              â”‚ $2,00/mÃªs    â”‚                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  âš ï¸ Problema: Duplicatas nÃ£o resolvidas

  DEPOIS (Glue Job):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Componente         â”‚ Custo/MÃªs    â”‚ ObservaÃ§Ãµes     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Glue Job (DPUs)    â”‚ $52,80       â”‚ 120 DPU-hours   â”‚
  â”‚ S3 Scripts         â”‚ $0,01        â”‚ < 1 MB          â”‚
  â”‚ S3 Temp            â”‚ $0,10        â”‚ Lifecycle 7d    â”‚
  â”‚ S3 (Silver)        â”‚ $0,30        â”‚ ~12 GB (dedup)  â”‚
  â”‚ CloudWatch Logs    â”‚ $0,50        â”‚ 14d retenÃ§Ã£o    â”‚
  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚ TOTAL              â”‚ $53,70/mÃªs   â”‚                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  âœ… BenefÃ­cio: Dados consolidados, sem duplicatas

  DiferenÃ§a: +$51,70/mÃªs (+2585%)
  ROI: Qualidade de dados + Escalabilidade + ConsolidaÃ§Ã£o

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DEPLOY CHECKLIST                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  PRÃ‰-DEPLOY:
  â˜ Terraform instalado (>= 1.0)
  â˜ AWS CLI instalado e configurado
  â˜ Credenciais AWS vÃ¡lidas
  â˜ Script PySpark validado (silver_consolidation_job.py)
  â˜ Backup do estado Terraform

  DEPLOY:
  â˜ cd terraform
  â˜ terraform init (se primeira vez)
  â˜ terraform plan (revisar mudanÃ§as)
  â˜ terraform apply (confirmar com 'yes')

  PÃ“S-DEPLOY:
  â˜ Verificar Glue Job criado
  â˜ Verificar Trigger habilitado
  â˜ Verificar Script no S3
  â˜ Verificar IAM Role e polÃ­ticas
  â˜ Teste manual: aws glue start-job-run
  â˜ Monitorar CloudWatch Logs
  â˜ Upload dados de teste
  â˜ Validar deduplicaÃ§Ã£o no Athena

  PRODUÃ‡ÃƒO:
  â˜ Monitorar execuÃ§Ãµes agendadas (1 semana)
  â˜ Validar custos (AWS Cost Explorer)
  â˜ Configurar alarmes CloudWatch
  â˜ Ajustar configuraÃ§Ãµes (workers, schedule)
  â˜ (Opcional) Remover Lambda Cleansing

```

---

**Legenda:**
- ğŸ“ = S3 Bucket
- âš¡ = AWS Lambda
- ğŸ”§ = AWS Glue Job
- â° = EventBridge Trigger
- ğŸ—ƒï¸ = Glue Data Catalog
- ğŸ“Š = Amazon Athena
- âœ… = Recurso criado
- âŒ = Recurso removido
- âšª = Sem alteraÃ§Ãµes
- âš ï¸ = Problema/LimitaÃ§Ã£o

**Autor**: Sistema de Data Lakehouse  
**Data**: 2025-10-30  
**VersÃ£o**: 1.0
